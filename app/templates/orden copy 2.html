{% extends "base.html" %}

{% block app_content %}
    <div class='container'>
        <div class="row">
            <div class="col-md-8">

                <!-- Encabezado conNro de Orden-->
                <div class="row">
                    <div class = "page-header"> <h4> Orden #{{orden.order_number}}</h4> </div>
                </div>
                
                <!-- Listado de articulos que entran-->
                <div class="row">
                    <div class = "page-header mt-2 mb-2 text-info font-weight-bold"> <h5> Articulos entrantes</h5> </div>
                </div>    

                <form id="entrante" action="{{ url_for('main.gestion_lineas_entrantes') }}" method="POST"> 
                    {% for i in orden_linea %}
                    <div class="card mb-2 ">
                        <div class="card-body">
                            <input type="hidden" id="prod_id" name="prod_id" value="{{ i['prod_id'] }}">
                            <div class="row">
                            <!-- Descripcio + datos articulos -->
                                <div class="col-xs-6 col-sm-6 col-md-8 col-lg-8">
                                    <strong> {{ i['name'] }} </strong> 
                                    <br> 
                                    Estado: 
                                    {% if i['gestionado'] == 'Si' %}
                                        Gestionado <i class="fa fa-check-square-o" aria-hidden="true"></i>
                                    {% else %}
                                        {{i['gestionado']}} 
                                    {% endif %}
                                    <div class="font-weight-light"><small>
                                        {{i['accion']}} - {{i['accion_cantidad']}}
                                        {% if i['accion'] == 'cambiar' %}
                                            &nbsp; x {{ i['accion_cambiar_por_desc'] }} 
                                        {% endif %}
                                        ({{i['motivo']}}) <br>  
                                    </small></div>
                                </div> <!-- end columna descr Articulos -->

                                <!-- Precios articulos -->
                                <div class="col-xs-6 col-sm-6 col-md-4 col-lg-4">
                                    <div class="float-right">

                                        <!-- Input del precio / el boton de editar solo aparece si la orden
                                        no ha sido gestioanda -->
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-prepend">
                                              <span class="input-group-text">$</span>
                                            </div>
                                            <input type="text" id="precio{{ i['prod_id'] }}" name="precio{{ i['prod_id'] }}" class="form-control" value="{{i['precio']}}">
                                            {% if orden.status_resumen == 'Aprobado' %}
                                                {% if (i.gestionado == 'Iniciado' or i.gestionado == 'Cambiado' ) %}
                                                    <div class="input-group-prepend">
                                                        <button id="boton_precio{{ i['prod_id'] }}" class="btn btn-outline-secondary" type="button" value="{{ i['prod_id'] }}">Editar</button>
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                        
                                        <br>
                                        {% if i.promo_descuento != 0 %} 
                                            Promo: {{i.promo_descuento}} ({{i.promo_nombre}})<br>
                                            final: {{i.promo_precio_final}}<br>
                                        {% endif %}
                                        
                                        <!-- muestra checkbox de restock solo si 
                                        la solicitud esta aprobada, pero no gestionada ni devuleta al stock -->
                                        {% if orden.status_resumen == 'Aprobado' %}
                                            {% if (i.gestionado == 'Iniciado' or i.gestionado == 'Cambiado' ) %}
                                                <div class="custom-control custom-checkbox">
                                                    <input type="checkbox" class="custom-control-input" id="stockradio{{ i['prod_id'] }}" name="stockradio{{ i['prod_id'] }}">
                                                    <label class="custom-control-label" for="stockradio{{ i['prod_id'] }}"><small>Restock</small></label>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div> <!-- end columna Precios -->
                            </div> <!-- end row -->
                        </div> <!-- end of card body -->
                    </div> <!-- end of card -->
                    {% endfor %}

                    {% if orden.status_resumen == 'Aprobado' %}
                            <!-- Ver como hacer para que aparezca solo si alguna de las lineas esta no gestionada o devuelta -->
                            <button class="btn btn-info btn-sm float-right mt-1 mb-1" type="submit"> Procesar</button>
                            <br>
                        
                    {% endif %}
                </form> <!-- end of formulario articulos entrantes -->

                <hr>
                <!-- Listado de articulos Saliente  -->
                <div class="row">
                    <div class = "page-header mt-2 mb-2"> <h5> Articulos salientes</h5> </div>
                </div>
                
                {% for i in orden_linea %}
                <div class="row">
                   
                    <!-- Descripcio + datos articulos salientes -->
                    <div class="col-xs-6 col-sm-6 col-md-8 col-lg-8">
                        <input type="hidden" id="sale_{{ i['prod_id'] }}" name="prod_Id" value="{{ i['prod_id'] }}">
                        {% if i['accion'] == 'cambiar' %}
                            <br>
                            <strong> {{ i['accion_cambiar_por_desc'] }} </strong> 
                            ({{ i['accion_cambiar_por'] }})
                            <br>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                <hr>


                <!-- Calculo de diferencia de precio -->
                <div class="row">
                        {% if orden.gastos_cupon != 0 %}
                            Cupon: {{orden.gastos_cupon}}
                        {% endif %}
                        {% if orden.gastos_gateway != 0 %} 
                            Desc. forma de pago: {{orden.gastos_gateway}}
                        {% endif %}
                        {% if orden.gastos_shipping_owner != 0 %} 
                            Costo envío vendedor: {{orden.gastos_shipping_owner}}
                        {% endif %}
                        {% if orden.gastos_shipping_customer != 0 %} 
                            Costo envío Cliente: {{orden.gastos_shipping_customer}}
                        {% endif %}
                        {% if orden.gastos_promocion != 0 %}
                            Dec. Promo: {{orden.gastos_promocion}}
                        {% endif %}       
                    </div>


                <!-- Botones -->

                <!-- Si el articulo Aún no fue RECIBIDO  -->
                {% if orden.status == 'Shipping' %}
                    <form id="coordinar_form" action="{{ url_for('main.gestionar_ordenes', orden_id = orden.id, accion_orden = 'toReject' ) }}" method="POST"> 
                        <input type="text" id="motivo" name="motivo" class="d-none" value=""> <br>
                        <input type="submit" id="submit-reject" class="d-none" />
                    </form>
                    <!-- Si el articulo Aún no fue CONFIRMADO  -->
                    {% if orden.sub_status == 'Solicitado' %}
                        <form id="coordinar_form" action="{{ url_for('main.gestionar_ordenes', orden_id = orden.id, accion_orden = 'toReject' ) }}" method="POST"> 
                            <input type="text" id="motivo" name="motivo" class="d-none" value=""> <br>
                            <input type="submit" id="submit-reject" class="d-none" />
                        </form>

                        <!-- Si no fue confirmado y el metodo de Envio elegido es COORDINAR  -->     
                        {% if orden.courier_method == 'Coordinar' %}
                            <label for="submit-form" tabindex="0" class="btn btn-primary" title='Pasa el pedido a LISTO PARA RETIRO'>Coordinar </label>
                        <!-- Si no fue confirmado y el metodo de Envio elegido es MOOVA o MANUAL  --> 
                        {% else %}
                        <a href="{{ url_for('main.gestionar_ordenes', orden_id = orden.id, accion_orden = 'toReady' ) }}">
                            <button class="btn btn-primary" title='Pasa el pedido a LISTO PARA RETIRO' > Confirmar </button></a> 
                        {% endif %}
                        
                        <!-- Boton de rechazo (previo a confirmación)  -->  
                        <label id="bton" for="submit-reject" tabindex="0" class="btn btn-outline-danger float-right" title='Rechaza el pedido'>Rechazar</label>
                    {% endif %}

                    <!-- Si el articulo Aún no fue RECIBIDO  pero ya esta confirmado -->
                    {% if orden.sub_status == 'Listo para retiro' %}
                    <a href="{{ url_for('main.gestionar_ordenes', orden_id = orden.id, accion_orden = 'toReceived' ) }}">
                        <button class="btn btn-primary" title='Pasa la orden a Recibida' > Recibir </button></a> 
                    {% endif %}

                    <!-- Si el articulo ya fue RECIBIDO  (aún no aprobado) -->
                    {% if orden.sub_status == 'Recibido' %}
                        <a href="{{ url_for('main.gestionar_ordenes', orden_id = orden.id, accion_orden = 'toApproved' ) }}">
                            <button class="btn btn-primary"> Revisar y Aprobar <i class="fa fa-check" aria-hidden="true"></i> </button></a>

                        <!-- Boton de rechazo (post confirmación, previo a recibir)  -->  
                        <label id="bton" for="submit-reject" tabindex="0" class="btn btn-outline-danger float-right" title='Rechaza el pedido'>Rechazar</label>      
                    {% endif %}
                {% endif %}
                
                <!-- Articulo RECIBIDO y APROBADO - Solicitud lista para getsionarse o gestionandose -->
                {% if orden.status == 'En Proceso' %}
                            La solicitud se está gestionando
                            {% if orden.status_resumen == 'Aprobado' %}
                                y fue aprobada
                            {% endif %}
                            {% if orden.status_resumen == 'Rechazado' %}
                                y No fue aprobada
                            {% endif %}
                {% endif %}

                <!-- Solicitud ya gestionada o Rechazada -->
                {% if orden.status == 'Cerrado' %}
                            La solicitud ya fue gestionada
                {% endif %}
            </div>
   
            <div class="col-md-4">
                <!-- Barra con Info ed Orden y de Cliente -->
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title"> <strong>
                            Estado: {{orden.status_resumen}} 
                            {% if orden.reject_reason != None %}
                                - {{orden.reject_reason}}
                            {% endif %}
                        </strong> </h5>    
                        <input type="hidden" id="ordenId" name="ordenId" value={{orden.id}}>

                        <!-- Info Orden -->
                        <p class="card-text"> <small>
                            Fecha de creación: {{ moment(orden.date_creation).format("DD/MM/YYYY")}} <br>
                            Método de Pago: {{orden.payment_method}}<br>
                            {% if orden.payment_card != None %}
                                - Tarjeta: {{orden.payment_card}} <br>
                            {% endif %}
                            {% set link_orden = empresa.store_url+'/admin/orders/'+orden.order_id_anterior|string %}
                            Ver compra en la Tienda:
                            <a href={{link_orden}} target="_blank" rel="noreferrer noopener"> Click Acá </a>
                            <hr>

                        <!-- Info Envio -->
                            <strong>Método de Envío: {{orden.courier_method}} </strong><br>
                            {% if orden.courier_method == 'Coordinar' %}
                                {% if orden.sub_status == 'Solicitado' %}
                                    <form id="coordinar_form" action="{{ url_for('main.gestionar_ordenes', orden_id = orden.id, accion_orden = 'toReady' ) }}" method="POST"> 
                                        <div class="form-group">
                                            <input type="text" class="form-control form-control-sm" id="coordinar_empresa" name="coordinar_empresa" value="" placeholder="correo">
                                            <input type="text" class="form-control form-control-sm" id="coordinar_guia" name="coordinar_guia" value="" placeholder="Guia">
                                        </div>
                                        <div class="form-group">
                                            <div class="form-check">   
                                                <input class="form-check-input" type="checkbox" id="coordinar_roundtrip" name="coordinar_roundtrip">
                                                <label class="form-check-label" for="coordinar_roundtrip"> Recogida + Entrega </label>
                                            </div>
                                        </div>
                                        <input type="submit" id="submit-form" class="d-none" />
                                    </form>
                                {% else %}
                                    Correo: {{orden.courier_coordinar_empresa}} <br>
                                    Guia: {{orden.courier_coordinar_guia}} <br>
                                    Recogida + entrega:
                                    {% if orden.courier_coordinar_roundtrip == True %}
                                        Si
                                    {% else %}
                                        No
                                    {% endif %}
                                    <br>
                                {% endif %}
                            {% endif %}        
                            {% if orden.courier_method == 'Moova' %}
                                Guia: {{ orden.courier_order_id }} <br>
                                {% if orden.status_resumen == 'Solicitado' %}
                                    Costo del Envío: {{orden.courier_precio}}<br>
                                {% endif %}
                            {% endif %}
                            <hr>

                        <!-- Info Cliente -->
                            <strong>Cliente {{customer.name}}</strong><br>
                            {{customer.email}} / {{customer.phone}} <br> 
                            {{orden.customer_address}}&nbsp{{orden.customer_number}}&nbsp{{orden.customer_floor}}<br>
                            {{orden.customer_locality}}&nbsp({{orden.customer_zipcode}})<br>
                            {{orden.customer_city}} &nbsp - &nbsp{{orden.customer_province}} <br>
                            <hr>

                        <!-- Notas --> 
                            <form id="Nota" action="{{ url_for('main.orden', orden_id = orden.id) }}" method="POST"> 
                                <label for="nota">Notas:</label>
                                <textarea class="form-control" style="height: 100px" id="nota" name="nota" placeholder="Notas" >{{orden.note}}</textarea>
                                <button  class="btn btn-outline-primary btn-sm mt-2 float-right" type="submit"> Añadir Nota </button>
                            </form>
                            
                        </small></p>
                    </div> <!-- end card body -->
                </div> <!-- end card -->            
            </div> <!-- end col-md-4 -->

        </div> <!-- end row -->
    </div> <!-- end container -->
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        $('#bton').on('click', function () {
            var reason = prompt("Motivo del Rechazo ): ");
            $("#motivo").val(reason)
        }); 
        
        // dehabilitar todos los Ids que comiencen con precio
        $(document).ready(function () {
            $('[id^="precio"]').prop("disabled", true);
        });

        // habilita la edicion del precio
        $(document).on("click", '#boton_precio'+$('#prod_id').val(), function() {
            valor = '#precio'+$('#prod_id').val();
            $(valor).prop("disabled", false);
        });


    </script>
{% endblock %}