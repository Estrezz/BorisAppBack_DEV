{% extends "base.html" %}

{% block app_content %}
    <div class='container'>

        <!-- Encabezado conNro de Orden-->
        {% set ns = namespace() %}

        <div class="row">
            <div class = "page-header"> <h4> Orden #{{orden.order_number}}</h4> </div>
        </div>
        
        <div class="row">
            <div class="col-md-8">

               
                <!-- Listado de ARTICULOS ENTRANTES -->
                <div class="row">
                    <div class = "page-header mt-2 mb-2 text-info font-weight-bold"> <h5> Articulos entrantes</h5> </div>
                </div>    
                {% set ns.entrantes_activos=false %}
                <form id="entrante" action="{{ url_for('main.gestion_lineas_entrantes', orden_id=orden.id) }}" method="POST"> 
                    {% for i in orden_linea %}
                    <div class="card mb-2 ">
                        <div class="card-body">     
                            <!-- graba los datos que se necesitan para poder procesar cada linea asociados al respectivo Id del producto -->
                            <input type="hidden" id="order_line" name="order_line" value="{{ i['order_line_number'] }}">
                            <input type="hidden" id="prod_id{{ i['order_line_number'] }}" name="prod_id{{ i['order_line_number'] }}" value="{{ i['prod_id'] }}">
                            <input type="hidden" id="variant{{ i['order_line_number'] }}" name="variant{{ i['order_line_number'] }}" value="{{ i['variant'] }}">
                            <input type="hidden" id="accion_cantidad{{ i['order_line_number'] }}" name="accion_cantidad{{ i['order_line_number'] }}" value="{{ i['accion_cantidad'] }}">
                            <input type="hidden" id="accion{{ i['order_line_number'] }}" name="accion{{ i['order_line_number'] }}" value="{{ i['accion'] }}">
                            <input type="hidden" id="order_line{{ i['order_line_number'] }}" name="order_line{{ i['order_line_number'] }}" value="{{ i['order_line_number'] }}">
                            
                            <div class="row">
                            <!-- Descripcio + datos articulos -->
                                <div class="col-xs-6 col-sm-6 col-md-8 col-lg-8">
                                    <strong> {{ i['name'] }} </strong> 
                                    <br> 
                                    
                                    <div class="font-weight-light">
                                        {% if i['accion'] == 'cambiar' %}
                                            <span class="badge badge-pill badge-info mr-2">Cambio</span>
                                            {{i['accion_cantidad']}} x {{ i['accion_cambiar_por_desc'] }} 
                                        {% endif %}
                                        {% if i['accion'] == 'devolver' %}
                                        <span class="badge badge-pill badge-dark mr-2">Devoluci√≥n</span>
                                        {{i['accion_cantidad']}}
                                        {% endif %}
                                        <br><span class="text-muted">({{i['motivo']}})</span><br>

                                        {% if i['observaciones'] %}
                                            <span class="text-muted">Observaciones: {{i['observaciones']}}</span><br>
                                        {% endif %}
                                        
                                    </div>
                                    <small>
                                    Estado: 
                                    {% if i['gestionado'] == 'Si' %}
                                        Gestionado <i class="fa fa-check-square-o" aria-hidden="true"></i>
                                    {% else %}
                                        {{i['gestionado']}} 
                                    {% endif %}
                                    </small>
                                </div> <!-- end columna descr Articulos -->

                                <!-- Precios articulos -->
                                <div class="col-xs-6 col-sm-6 col-md-4 col-lg-4">
                                    <div class="float-right">
                                        <!-- Input del precio se habilita solo aparece si la orden no ha sido gestioanda -->
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-prepend">
                                              <span class="input-group-text">$</span>
                                            </div>
                                            {% if orden.status_resumen == 'Aprobado' %}
                                                {% if (i.gestionado == 'Iniciado' or i.gestionado == 'Cambiado' ) %}
                                                    {% set ns.entrantes_activos=true %}
                                                    <input type="text" id="precio{{ i['order_line_number'] }}" name="precio{{ i['order_line_number'] }}" class="form-control" value="{{i['precio'] * i['accion_cantidad']}}">
                                                {% else %}
                                                    <input type="text" id="precio{{ i['order_line_number'] }}" name="precio{{ i['order_line_number'] }}" class="form-control" value="{{i['monto_devuelto']}}" disabled>
                                                {% endif %} 
                                            {% else %}
                                                <input type="text" id="precio{{ i['order_line_number'] }}" name="precio{{ i['order_line_number'] }}" class="form-control" value="{{i['precio'] * i['accion_cantidad']}}" disabled>
                                            {% endif %}
                                        </div>
                                        
                                        <br>
                                        {% if i.promo_descuento != 0 %} 
                                            Promo: {{i.promo_descuento}} ({{i.promo_nombre}})<br>
                                            final: {{i.promo_precio_final}}<br>
                                        {% endif %}
                                        
                                        <!-- muestra checkbox de restock solo si 
                                        la solicitud esta aprobada, pero no gestionada ni devuleta al stock -->
                                        {% if orden.status_resumen == 'Aprobado' %}
                                            {% if (i.gestionado == 'Iniciado' or i.gestionado == 'Cambiado' ) %}
                                                <div class="custom-control custom-checkbox">
                                                    <input type="checkbox" class="custom-control-input" id="stockradio{{ i['order_line_number'] }}" name="stockradio{{ i['order_line_number']}}" checked>
                                                    <label class="custom-control-label" for="stockradio{{ i['order_line_number'] }}"><small>Restock</small></label>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div> <!-- end columna Precios -->
                            </div> <!-- end row -->
                        </div> <!-- end of card body -->
                    </div> <!-- end of card -->
                    {% endfor %}

                    {% if orden.status_resumen == 'Aprobado' %}
                        {% if ns.entrantes_activos == true %}
                            <!-- Ver como hacer para que aparezca solo si alguna de las lineas esta no gestionada o devuelta -->
                            <button class="btn btn-info btn-sm float-right mt-1 mb-1" type="submit"> Ingresar Articulos </button>
                            <br>
                        {% endif %}
                    {% endif %}
                </form> <!-- end of formulario articulos entrantes -->

                <hr>

<!-- Listado de ARTICULOS SALIENTES  ----->
                <div class="row">
                    <div class = "page-header mt-2 mb-2 text-info font-weight-bold"> <h5> Articulos salientes</h5> </div>
                </div> 
                
                <form id="salientes" action="{{ url_for('main.gestion_lineas_salientes', orden_id=orden.id) }}" method="POST"> 
                    <!--Setea la variable saliente_tmp para comprobar si hay articulos salientes 
                    ns.saliente_acitov para ver si quedan lineas con articulos salientes no procesadas aun-->
                    {% set ns.saliente_tmp=false %}
                    {% set ns.saliente_activo=false %}

                    {% for i in orden_linea %}
                        {% if (i['accion'] == 'cambiar' and i['accion_cambiar_por'] != 1 ) %}
                        {% set ns.saliente_tmp = true %}
                        <input class="saliente" type="hidden" id="prod_id_saliente" name="prod_id_saliente" value="{{ i['prod_id'] }}" data-variante="{{ i['accion_cambiar_por']}}" data-prod_id="{{ i['prod_id'] }}" data-cambiar_por_prod_id="{{ i['accion_cambiar_por_prod_id'] }}" data-line_saliente="{{ i['order_line_number'] }}">
                        <input type="hidden" id="order_line_saliente" name="order_line_saliente" value="{{ i['order_line_number'] }}">
                        <div class="card mb-2 ">
                            <div class="card-body">
                                <div class="row">
                                <!-- Descripcion + datos articulos salientes -->
                                    <div class="col-xs-6 col-sm-6 col-md-8 col-lg-8">
                                        <strong> {{ i['accion_cambiar_por_desc'] }} </strong> <br>
                                            {% if i['prod_id'] == i['accion_cambiar_por_prod_id'] %}
                                            <span class="badge badge-pill badge-success mr-2"> Cambio x Variante </span><br>
                                            {% else %}
                                            <span class="badge badge-pill badge-warning mr-2">Cambio x Otro Producto</span><br>
                                            {% endif %}
                                            <small class="text-muted">
                                            Stock Actual: <span type="text" id="stock{{ i['order_line_number'] }}" name="stock{{ i['order_line_number'] }}"></span> /
                                            Precio: <span type="text" id="saliente_precio{{ i['order_line_number'] }}" name="saliente_precio{{ i['order_line_number'] }}"></span>
                                                    <!-- guarda el precio promocional y lo muestra si existiera con Jquery-->
                                                    <input type="hidden" id="saliente_precio_promo{{ i['order_line_number'] }}" name="saliente_precio_promo{{ i['order_line_number'] }}" value=0 >
                                                    <span type="text" id="saliente_precio_promo_desc{{ i['order_line_number'] }}" name="saliente_precio_promo_desc{{ i['order_line_number'] }}"></span>
                                            </span> 
                                            <br>
                                            </small>
                                            <small>
                                                Estado: 
                                                {% if i['gestionado'] == 'Si' %}
                                                    Gestionado <i class="fa fa-check-square-o" aria-hidden="true"></i>
                                                {% else %}
                                                    {{i['gestionado']}} 
                                                {% endif %}
                                            </small>
                                    </div>
                    
                                    <div class="col-xs-6 col-sm-6 col-md-4 col-lg-4">
                                        <div class="float-right">
                                            <input class="diferencia" type="hidden" id="saliente_diferencia_precio{{ i['order_line_number'] }}" name="saliente_diferencia_precio{{ i['order_line_number'] }}" value=0 >
                                            {% if (orden.status_resumen == 'Aprobado' or (orden.courier_coordinar_roundtrip == true and orden.status_resumen != 'Cerrado')) %}
                                            {% if (i.gestionado == 'Iniciado' or i.gestionado == 'Devuelto' ) %}
                                                {% set ns.saliente_activo = true %}
                                                <small>
                                                <!-- campo para mostrar si hay diferencia de precio -->
                                                <span class="float-right" type="hidden" id="saliente_diferencia_precio_desc{{ i['order_line_number'] }}" name="saliente_diferencia_precio_desc{{ i['order_line_number'] }}"></span>
                                            </small>
                                            {% endif %}
                                        {% endif %}
                                        </div>
                                    </div>
                                </div> <!-- end of row Articulos Saliente -->
                            </div> <!-- end of card SALIENTE body -->
                        </div> <!-- end of card SALIENTE -->
                        {% endif %}
                    {% endfor %}

                    {% if ns.saliente_tmp == false %}
                        <strong> No hay articulos salientes para gestionar </strong> <br>
                   {% else %}
             
                        <!-- Calculo Total a Pagar/ Devolver-->
                        {% if ((orden.status_resumen == 'Aprobado' and ns.saliente_activo == true) or (orden.courier_coordinar_roundtrip == true and orden.status_resumen != 'Cerrado' and ns.saliente_activo == true)) %}
                            <hr>
                            <input type="hidden" id="diferencia_total" name="diferencia_total" value=0 />

                            <div class="row">
                                <div class="card bg-light">
                                    
                                        <p class="mt-2 mb-2 mr-2 ml-2 text-muted"><small>
                                        Record√° que este c√°lculo es meramente informativo. Tanto la devoluci√≥n como el cobro del dinero debe hacerse por el canal que corresponda
                                        </small></p>
                                    
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                                    <!-- Descuentos de la Orden -->
                                <div class = "page-header mt-2 mb-2 text-info font-weight-bold"> <h6> Descuentos Orden Original</h6> </div>

                                    <!-- total descuentos orden -->
                                    {% if orden.gastos_gateway != 0 %} 
                                        <div class="input-group input-group-sm mb-2 float-right">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text" id="descFormaPago">Desc. Forma de Pago $</span>
                                            </div>
                                            <input type="text" id="descuentos_forma_pago" name="descuentos_forma_pago" class="form-control text-right" aria-describedby="descFormaPago" value="{{orden.gastos_gateway}}" disabled>
                                        </div>
                                        <br>
                                    {% endif %}
                                
                                    {% if orden.gastos_cupon != 0 %}
                                        <div class="input-group input-group-sm mb-2 float-right">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text" id="descCupon">Cup√≥n $</span>
                                            </div>
                                            <input type="text" id="descuentos_cupon" name="descuentos_cupon" class="form-control text-right" aria-describedby="descCupon" value="{{orden.gastos_cupon}}" disabled>
                                        </div>
                                        <br>
                                    {% endif %}
                                
                                    {% if orden.gastos_shipping_owner != 0 %} 
                                        <div class="input-group input-group-sm mb-2 float-right">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text" id="costo_envio_owner">Costo Env√≠o Merchant $</span>
                                            </div>
                                            <input type="text" id="descuentos_costo_envio_owner" name="descuentos_costo_envio_owner" class="form-control text-right" aria-describedby="costo_envio_owner" value="{{orden.gastos_shipping_owner}}" disabled>
                                        </div>
                                        <br>
                                    {% endif %}

                                    {% if orden.gastos_shipping_customer != 0 %} 
                                        <div class="input-group input-group-sm mb-2 float-right">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text" id="costo_envio_cliente">Costo Env√≠o Cliente $</span>
                                            </div>
                                            <input type="text" id="descuentos_costo_envio_cliente" name="descuentos_costo_envio_cliente" class="form-control text-right" aria-describedby="costo_envio_cliente" value="{{orden.gastos_shipping_customer}}" disabled>
                                        </div>
                                        <br>
                                    {% endif %}

                                    {% if orden.gastos_promocion != 0 %}
                                        <div class="input-group input-group-sm mb-2 float-right">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text" id="gastos_promo">Desc. Promo $</span>
                                            </div>
                                            <input type="text" id="descuentos_promo" name="descuentos_promo" class="form-control text-right" aria-describedby="gastos_promo" value="{{orden.gastos_promocion}}" disabled>
                                        </div>
                                        <br>
                                    {% endif %}                                
                                </div> <!-- end of Column-->

                                <!-- Calculo de valor a pagar/devolver -->
                                <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                                    <div class = "page-header mt-2 mb-2 text-info font-weight-bold"> <h6> Diferencia de Precio </h6> </div>
                                        <!-- Suma total de diferencias de los cambios -->
                                        <div class="input-group input-group-sm mb-2 float-right">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text" id="totalDiferencia">Total diferencias $</span>
                                            </div>
                                            <input type="text" id="diferencia_total_desc" name="diferencia_total_desc" class="form-control text-right" aria-describedby="totalDiferencia" disabled>
                                        </div>
                                        <br>

                                        <!-- Costo Envio nueva Orden -->
                                        <div class="input-group input-group-sm mb-2 float-right">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text" id="nuevaOrdenEnvio">Costo Envio $</span>
                                            </div>
                                            <input type="text" id="envio_nueva_orden" name="envio_nueva_orden" class="form-control text-right" aria-describedby="nuevaOrdenEnvio" value="{{orden.nuevo_envio_costo}}">
                                        </div>
                                        <br>

                                        <!-- Otros Gastos -->
                                        <div class="input-group input-group-sm mb-2 float-right">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text" id="nuevaOrdenTotal">Total $</span>
                                            </div>
                                            <input type="text" id="total_nueva_orden" name="total_nueva_orden" class="form-control text-right" aria-describedby="nuevaOrdenTotal" value="{{orden.nuevo_envio_total}}">
                                        </div>
                                        <br>
                                </div> <!-- end of column -->

                            <!--end of row-->
                        
                            <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                            <small>
                                <div class = "page-header mt-2 mb-2 text-info font-weight-bold"> <h6> Generar nueva Orden </h6> </div>
                                <div class="custom-control custom-radio ml-4">
                                <input type="radio" id="nuevaorden_manual" name="nuevaorden" class="custom-control-input" value="manual">
                                <label class="custom-control-label" for="nuevaorden_manual">Manual</label>
                            </div>
                            <div class="custom-control custom-radio ml-4">
                                <input type="radio" id="nuevaorden_manual_stock" name="nuevaorden" class="custom-control-input" value="manual_stock">
                                <label class="custom-control-label" for="nuevaorden_manual_stock">Manual (dando de baja stock)</label>
                            </div>
                            <div class="custom-control custom-radio ml-4">
                                <input type="radio" id="nuevaorden_tienda" name="nuevaorden" class="custom-control-input" value="tienda">
                                <label class="custom-control-label" for="nuevaorden_tienda">Tienda</label>
                            </div>
                            </small> 

                            <!-- modal -->
                            {% if orden.courier_method != 'Manual' %}
                            <button type="button" class="btn btn-info btn-sm float-right mt-2 mb-2" data-toggle="modal" data-target="#coordinar_datos" >Datos del Env√≠o coordinado </button>

                            <div class="modal fade" id="coordinar_datos" tabindex="-1" role="dialog" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h6>Datos del Nuevo Envio</h6>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">x</button>
                                        </div>
                                        <div class="modal-body">
                                            
                                            <div class="form-group">
                                                <label for="empresa_coordinada" class="col-form-label">Correo:</label>
                                                <input type="text" class="form-control" id="empresa_coordinada" name="empresa_coordinada" value="{{orden.metodo_envio_correo}}">
                                            </div>
                                            <div class="form-group">
                                                <label for="guia_coordinada" class="col-form-label">Guia:</label>
                                                <input type="text" class="form-control" id="guia_coordinada" name="guia_coordinada" value="{{orden.metodo_envio_guia}}">
                                            </div>
                                            
                                            <p><button id="modalButton" type="submit" class="btn btn-info btn-sm float-right mt-2 mb-2">Guardar</button></p>
                                        </div>

                                        <div class="modal-footer">
                                        </div>

                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            <!-- end modal-->
                            
                            <button class="btn btn-info btn-sm float-right mt-2 mb-2" type="submit"> Generar nueva Orden </button>
                            <br>
                            
                            </div> <!-- end of column -->
                        </div>

                         <!-- Alerta si se va a generar la etiqueta-->
                         <div id="sale_etiqueta_round">
                            <div class="row">
                                <div class="col-8 mx-auto ">
                                    <mark><small><b>
                                        &nbsp;&nbsp;Se va a generar la gu√≠a. Si corresponde, recuerde cobrar el Env√≠o&nbsp;&nbsp;
                                    </b></small></mark>
                                </div>
                            <br>
                            </div>
                        </div>
                        <!-- Fin de alerta-->

                        {% endif %}
                    {% endif %}
                </form>

                <hr>

                
                <!-- Listado de ARTICULOS c/Cupon  ----->
                <div class="row">
                    <div class = "page-header mt-2 mb-2 text-info font-weight-bold"> <h5> Cupones </h5> </div>
                </div> 
                <!--setea la variable ns.cupontmp en false apra saber si hay alguna linea con Cupon -->
                {% set ns.cupontmp=false %}
                <!--setea la variable ns.cupon_activo en false para comprobar luego si hay alguna linea con cupon 
                    PENDIENTE  de gestionar -->
                {% set ns.cupon_activo=false %}
                

                <form id="cupones" action="{{ url_for('main.gestion_lineas_cupones', orden_id=orden.id) }}" method="POST"> 
                    {% for i in orden_linea %}
                        {% if (i['accion'] == 'cambiar' and i['accion_cambiar_por'] == 1 ) %}
                        {% set ns.cupontmp = true %}
                        <input class="cupomes" type="hidden" id="prod_id_cupon" name="prod_id_cupon" value="{{ i['prod_id'] }}" data-variante="{{ i['accion_cambiar_por']}}" data-prod_id="{{ i['prod_id'] }}" data-cambiar_por_prod_id="{{ i['accion_cambiar_por_prod_id'] }}">
                        <input type="hidden" id="order_line_cupon" name="order_line_cupon" value="{{ i['order_line_number'] }}">
                        <div class="card mb-2 ">
                            <div class="card-body">
                                <div class="row">
                                <!-- Descripcion + datos articulos copn cupon  -->
                                    <div class="col-xs-6 col-sm-6 col-md-8 col-lg-8">
                                        <strong> Cup√≥n  x {{ i['name'] }} </strong> <br>
                                        <small>
                                            Estado: 
                                            {% if i['gestionado'] == 'Si' %}
                                                Gestionado <i class="fa fa-check-square-o" aria-hidden="true"></i>
                                            {% else %}
                                                {{i['gestionado']}} 
                                            {% endif %}
                                        </small>
                                    </div>

                                    <div class="col-xs-6 col-sm-6 col-md-4 col-lg-4">
                                        <div class="float-right">
                                            <div class="input-group input-group-sm">
                                                <div class="input-group-prepend">
                                                  <span class="input-group-text">$</span>
                                                </div>
                                                {% if orden.status_resumen == 'Aprobado' %}
                                                    <!-- setea el valor por defecto del monto del cupon para el articulo -->
                                                    {% if i.monto_devuelto != 0 %}
                                                        {% set valor_cupon_default = i.monto_devuelto %}
                                                    {% else %}
                                                        {% set valor_cupon_default = i.precio %}
                                                    {% endif %}

                                                    {% if (i.gestionado == 'Iniciado' or i.gestionado == 'Devuelto' ) %}
                                                        <!-- setea la variable ns.cupon_activa para indicar que hay cupones pendientes de gestion-->
                                                        {% set ns.cupon_activo = true %}
                                                        <input type="text" id="cupon{{ i['prod_id'] }}" name="cupon{{ i['prod_id'] }}" class="form-control cupones" value="{{valor_cupon_default}}">
                                                    {% else %}
                                                        <input type="text" id="cupon{{ i['prod_id'] }}" name="cupon{{ i['prod_id'] }}" class="form-control cupones" value="{{i['precio']}}" disabled>
                                                    {% endif %}
                                                {% else %}
                                                <input type="text" id="cupon{{ i['prod_id'] }}" name="cupon{{ i['prod_id'] }}" class="form-control cupones" value="{{i['precio']}}" disabled>
                                                {% endif %}
                                            </div>  
                                        </div>
                                    </div>

                                </div> <!--end of row card (cupones)--> 
                            </div> <!--end od card body (cupones)-->
                        </div> <!-- end of card (cupones)-->
                        {% endif %}
                    {% endfor %}
                    
                    {% if ns.cupontmp == false %}
                        <strong> No hay cupones para gestionar </strong> <br>
                    {% else %}
                        <div class="row">
                        <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8">
                        </div>
                        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                            {% if ns.cupon_activo == true %}
                                <div class="input-group input-group-sm mb-2 float-right">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="cuponTotal">Total Cupones $</span>
                                    </div>            
                                        <input type="text" id="total_cupon" name="total_cupon" class="form-control text-right" aria-describedby="nuevaOrdenTotal" value=0>
                                </div>
                                
                                <button class="btn btn-info btn-sm float-right mt-2 mb-2" type="submit"> Generar cup√≥n</button>
                            {% else %}
                                <br><br>
                            {% endif %}

                            <br>
                        </div>
                        </div>
                    {% endif %}
                </form>

                <!-- Botones -->
                <!-- Se usan estos campos para la alerta para etiquetas -->
                <input type="hidden" id="estado_orden" name="estado_orden" value={{orden.status_resumen}}>
                <input type="hidden" id="tiene_salientes" name="tiene_salientes" value={{orden.salientes}}>
                <input type="hidden" id="es_roundtrip" name="es_roundtrip" value={{orden.courier_coordinar_roundtrip}}>
                <input type="hidden" id="tiene_carrier" name="tiene_carrier" value={{envio.carrier}}>
                

                <!-- Si el articulo A√∫n no fue RECIBIDO  -->
                {% if orden.status == 'Shipping' %}
                    <form id="coordinar_form" action="{{ url_for('main.gestionar_ordenes', orden_id = orden.id, accion_orden = 'toReject' ) }}" method="POST"> 
                        <input type="text" id="motivo" name="motivo" class="d-none" value=""> <br>
                        <input type="submit" id="submit-reject" class="d-none" />
                    </form>
                    <!-- Si el articulo A√∫n no fue CONFIRMADO  -->
                    {% if orden.sub_status == 'Solicitado' %}
                        <form id="coordinar_form" action="{{ url_for('main.gestionar_ordenes', orden_id = orden.id, accion_orden = 'toReject' ) }}" method="POST"> 
                            <input type="text" id="motivo" name="motivo" class="d-none" value=""> <br>
                            <input type="submit" id="submit-reject" class="d-none" />
                        </form>

                        
                        <!-- Si no fue confirmado y el metodo de Envio elegido es COORDINAR  --> 
                        {% if orden.courier_method != 'Manual' %}
                            <label for="submit-form" tabindex="0" class="btn btn-primary" title='Pasa el pedido a LISTO PARA RETIRO'> Confirmar </label>
                        <!-- Si no fue confirmado y el metodo de Envio elegido MANUAL  --> 
                        {% else %}
                        <a href="{{ url_for('main.gestionar_ordenes', orden_id = orden.id, accion_orden = 'toReady' ) }}">
                            <button class="btn btn-primary" title='Pasa el pedido a LISTO PARA RETIRO' > Confirmar </button></a> 
                        {% endif %}
                        
                        
                        <!-- Boton de rechazo (previo a confirmaci√≥n)  -->  
                        <label id="bton" for="submit-reject" tabindex="0" class="btn btn-outline-danger float-right" title='Rechaza el pedido'>Rechazar</label>
                    {% endif %}

                    <!-- Si el articulo A√∫n no fue RECIBIDO  pero ya esta confirmado -->
                    {% if orden.sub_status == 'Listo para retiro' %}
                    <a href="{{ url_for('main.gestionar_ordenes', orden_id = orden.id, accion_orden = 'toReceived' ) }}">
                        <button class="btn btn-primary" title='Pasa la orden a Recibida' > Recibir </button></a> 
                    {% endif %}

                    <!-- Si el articulo ya fue RECIBIDO  (a√∫n no aprobado) -->
                    {% if orden.sub_status == 'Recibido' %}
                        <a href="{{ url_for('main.gestionar_ordenes', orden_id = orden.id, accion_orden = 'toApproved' ) }}">
                            <button class="btn btn-primary"> Revisar y Aprobar <i class="fa fa-check" aria-hidden="true"></i> </button></a>

                        <!-- Boton de rechazo (post confirmaci√≥n, previo a recibir)  -->  
                        <label id="bton" for="submit-reject" tabindex="0" class="btn btn-outline-danger float-right" title='Rechaza el pedido'>Rechazar</label>      
                    {% endif %}

                    <!-- Alerta si se va a generar la etiqueta-->
                    <div id="sale_etiqueta">
                        <div class="row">
                            <div class="col-8 mx-auto ">
                                <mark><small><b>
                                    &nbsp;&nbsp;Se va a generar la gu√≠a. Si corresponde, recuerde cobrar el Env√≠o&nbsp;&nbsp;
                                </b></small></mark>
                            </div>
                        <br>
                        </div>
                    </div>

                {% endif %}
                
              
            </div>
   
            <div class="col-md-4">
                <!-- Barra con Info ed Orden y de Cliente -->
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title"> <strong>
                            Estado: {{orden.status_resumen}} 
                            {% if orden.reject_reason != None %}
                                - {{orden.reject_reason}}
                            {% endif %}
                        </strong> </h5>    
                        <input type="hidden" id="ordenId" name="ordenId" value={{orden.id}}>

                        <!-- Info Orden -->
                        <p class="card-text"> <small>
                            Fecha de creaci√≥n: {{ moment(orden.date_creation).format("DD/MM/YYYY")}} <br>
                            M√©todo de Pago: {{orden.payment_method}}<br>
                            {% if orden.payment_card != None %}
                                - Tarjeta: {{orden.payment_card}} <br>
                            {% endif %}
                            {% set link_orden = empresa.store_url+'/admin/orders/'+orden.order_id_anterior|string %}
                            Ver compra en la Tienda:
                            <a href={{link_orden}} target="_blank" rel="noreferrer noopener"> Click Ac√° </a>
                            <hr>

                        <!-- Info Envio -->
                            <h5>M√©todo de Env√≠o: {{orden.courier_method}}</h5>
                            
                            {% if orden.courier_method != 'Manual' %}
                                {% if orden.sub_status == 'Solicitado' %}
                                    <form id="coordinar_form" action="{{ url_for('main.gestionar_ordenes', orden_id = orden.id, accion_orden = 'toReady' ) }}" method="POST"> 
                                        <div class="form-group">
                                            <input type="text" class="form-control form-control-sm" id="metodo_envio_correo" name="metodo_envio_correo" value="{{orden.metodo_envio_correo}}" placeholder="correo">
                                            <input type="text" class="form-control form-control-sm" id="metodo_envio_guia" name="metodo_envio_guia" value="{{orden.metodo_envio_guia}}" placeholder="Guia">
                                        </div>
                                        <div class="form-group">
                                            <div class="form-check">   
                                                <input class="form-check-input" type="checkbox" id="coordinar_roundtrip" name="coordinar_roundtrip">
                                                <label class="form-check-label" for="coordinar_roundtrip"> Retiro + Entrega </label>
                                            </div>
                                        </div>
                                        <input type="submit" id="submit-form" class="d-none" />
                                    </form>
                                {% else %}
                                    Correo: {{orden.metodo_envio_correo}} <br>
                                    Guia: {{orden.metodo_envio_guia}} 

                                    {% if orden.etiqueta_generada == True %}
                                        <form id="Etiqueta" action="{{ url_for('main.etiqueta', orden_id = orden.id) }}" method="POST"  style="display: inline;"> 
                                            <button  class="btn btn-link btn-sm " type="submit"> Ver Guia </button>
                                        </form>
                                    {% endif %}
                                    <br>

                                    Retiro + entrega:
                                    {% if orden.courier_coordinar_roundtrip == True %}
                                        Si
                                    {% else %}
                                        No
                                    {% endif %}
                                    <br>
                                {% endif %}

                                {% if orden.courier_precio|int != 0  %}
                                    Costo del Env√≠o: {{orden.courier_precio}} $ <br>
                                {% endif %}

                            {% endif %}        
                            {% if orden.courier_method == 'Moova' %}
                                Guia: {{ orden.courier_order_id }} <br>
                                {% if orden.status_resumen == 'Solicitado' %}
                                    Costo del Env√≠o: {{orden.courier_precio}}<br>
                                {% endif %}
                            {% endif %}
                            <hr>

                        <!-- Info Cliente -->
                            <strong>Cliente {{customer.name}}</strong><br>
                            <a href="mailto:{{customer.email}}">{{customer.email}}</a> /
                            <a href="https://wa.me/{{customer.phone}}" target="_blank">{{customer.phone}}</a>
                            <br> 
                            {{orden.customer_address}}&nbsp{{orden.customer_number}}&nbsp{{orden.customer_floor}}<br>
                            {{orden.customer_locality}}&nbsp({{orden.customer_zipcode}})<br>
                            {{orden.customer_city}} &nbsp - &nbsp{{orden.customer_province}} <br>
                            <hr>
                        
                        <!-- Pagos --> 
                        {% if orden.reembolsado == true %}
                            {% set estado_reembolsado = "Reembolsado" %}
                        {% else %}
                            {% set estado_reembolsado = "Sin Reembolso" %}
                        {% endif %}

                        {% if empresa.pagos == true and (orden.reembolsado == false or orden.reembolsado == None) and orden.status_resumen != 'Cerrado'%}
                        <strong class="mb-2">Reembolsos / Saldos </strong><br>
                            <form id="pagos" action="{{ url_for('main.pagos', orden_id = orden.id) }}" method="POST"> 
                                <label for="pagos_status">Estado :</label>
                                <strong>{{estado_reembolsado}}</strong><br>
                                <button  class="btn btn-outline-primary btn-sm mt-2 float-right" type="submit"> Reembolsos / Saldos </button>
                            </form>
                            <br>
                            <br>
                            <hr>
                        {% endif %}

                        {% if empresa.pagos == true and orden.reembolsado == true %}
                            <strong>Reembolsos / Saldos </strong><br>
                            <label for="pagos_status">Estado :</label>
                            <strong>{{estado_reembolsado}}</strong><br>
                            <br>
                            <hr>
                        {% endif %}

                        <!-- Fin Pagos --> 
                        
                        <!-- Notas --> 
                            <form id="Nota" action="{{ url_for('main.orden', orden_id = orden.id) }}" method="POST"> 
                                <label for="nota">Notas:</label>
                                <textarea class="form-control" style="height: 100px" id="nota" name="nota" placeholder="Notas" >{{orden.note or ''}}</textarea>
                                <button  class="btn btn-outline-primary btn-sm mt-2 float-right" type="submit"> A√±adir Nota </button>
                            </form>
                            
                        </small></p>
                    </div> <!-- end card body -->
                </div> <!-- end card -->            
            </div> <!-- end col-md-4 -->

        </div> <!-- end row -->
    </div> <!-- end container -->
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>

        $('#sale_etiqueta').hide(); 
        $('#sale_etiqueta_round').hide(); 

        $('#bton').on('click', function () {
            var reason = prompt("Motivo del Rechazo ): ");
            $("#motivo").val(reason)
        }); 
        
        $('#envio_nueva_orden').keypress(function(e) {
            if (e.keyCode == '13') {
                e.preventDefault();}
                $('#total_nueva_orden').focus()
        });
        
        $('#total_nueva_orden').keypress(function(e) {
            if (e.keyCode == '13') {
                e.preventDefault();}
        });

        
        $(function () {
            var rountrip = 'Sin definir';
            if ($('#es_roundtrip').val() == true){
                roundtrip = 'Si';
            } else {
                roundtrip = 'No';
            }
            alerta_etiqueta(); //this calls it on load
            $("#coordinar_roundtrip").change(alerta_etiqueta);
        });
        
        function alerta_etiqueta() {
            if ($('#coordinar_roundtrip').is(":checked")) {
                roundtrip = 'Si';
            } else {
                roundtrip = 'No';
            }
            
            estado_orden = $('#estado_orden').val();
            tiene_salientes = $('#tiene_salientes').val();
            tiene_carrier = $('#tiene_carrier').val();
            
            if (estado_orden == 'Solicitado' && tiene_salientes == 'Si' && tiene_carrier == 'True' && roundtrip == 'No')  {
                $('#sale_etiqueta').show(); 
            } else if (estado_orden == 'Solicitado' && tiene_carrier == 'True' && tiene_salientes == 'No') {
                $('#sale_etiqueta').show(); 
            //} else if (estado_orden == 'En' && tiene_salientes == 'Si' && tiene_carrier == 'True' && roundtrip == 'Si') {
            } else if (estado_orden == 'En' && tiene_salientes == 'Si'&& tiene_carrier == 'True' && $('#es_roundtrip').val() == 'True') {
                $('#sale_etiqueta_round').show(); 
            } else {
                $('#sale_etiqueta').hide(); 
            }       
        }



        $('#envio_nueva_orden').on('change', function() {
            var total_diferencia = parseFloat($('#diferencia_total_desc').val() );
            var total_envio = parseFloat($('#envio_nueva_orden').val());
            $('#total_nueva_orden').val(total_diferencia + total_envio);
        });

        $("#modalButton").on("click", function(e){
            e.preventDefault(); // prevent de default action, which is to submit
            // save your value where you want
            //data.select = $("#exampleSelect").value();
            //alert('se cierra modal');
            jQuery.noConflict();
            $('#coordinar_datos').modal('hide');
            //alert('se cerro ?');
            // or call the save function here
            // save();
            $(this).prev().click();
        });
        
        // habilita la edicion del precio
        //$(document).on("click", '#boton_precio'+$('#prod_id').val(), function() {
        //    valor = '#precio'+$('#prod_id').val();
        //    $(valor).prop("disabled", false);
        //});
        
        var total_diferencia = 0;
        var total_cupon =0;
        var contador = 0;
        var contador_cupones =0;
        var total_salientes = document.querySelectorAll('.saliente').length;
        var total_cupones = document.querySelectorAll('.cupones').length;

        $('.saliente').each(function() {
            variante = $(this).data('variante');
            prod_id = $(this).data('prod_id');
            cambiar_por_prod_id = $(this).data('cambiar_por_prod_id');
            line_saliente = $(this).data('line_saliente');
            buscar_variante(prod_id, cambiar_por_prod_id, variante, line_saliente);
        });


        function buscar_variante(prod_id, cambiar_por_prod_id, variante, line_saliente) {  
            $.post('/buscar_variante', {
                prod_id: cambiar_por_prod_id,
                variante: variante
            }).done(function(response) {
                data = JSON.parse(response);
                $('#stock'+line_saliente).html(data['stock']);
                $('#saliente_precio'+line_saliente).html(data['price']);
                if (data['promotional_price'] != null) {
                    $('#saliente_precio_promo'+line_saliente).html(data['promotional_price']);
                    $('#saliente_precio_promo_desc'+line_saliente).html('(Promo: '+data['promotional_price']+')');
                    var precio = data['promotional_price'];
                } else {
                    var precio = data['price'];
                }
                // calcula la diferencia de precio entre el precio del articulo y el valor del cambio
                var cantidad = $('#accion_cantidad'+line_saliente).val();
                var diferencia = (precio * cantidad) - ($('#precio'+line_saliente ).val());
                
                $('#saliente_diferencia_precio'+line_saliente).val(diferencia);

                // acumula el valor de todas las diferencias
                total_diferencia += diferencia;
                contador += 1;
                // Si ya se sumaron todos, pone el valor al final
                if (contador == total_salientes ) {
                    $('#diferencia_total').html(total_diferencia);
                    $('#diferencia_total_desc').val(total_diferencia);
                    // actualiza total de la orden
                    var total_total = parseFloat(total_diferencia) + parseFloat($('#envio_nueva_orden').val());
                    
                    if(isNaN(total_total)) {
                        $('#total_nueva_orden').val(0)
                    } else {
                        $('#total_nueva_orden').val(total_total) 
                    }
                }

                // Arma texto para mostrar diferencia
                var texto_diferencia = "";
                var color ="";
                var color_back ="";
                if(isNaN(diferencia)) {
                    texto_diferencia = '&nbsp; NO SE ENCONTR√ì EL ARTICULO &nbsp;';
                    color = 'white';
                    color_back ="FireBrick";
                } else if (diferencia > 0) {
                    texto_diferencia = '&nbsp; A cobrar '+Math.abs(diferencia)+'$ &nbsp;';
                    color = 'white';
                    color_back ="FireBrick";
                } else if(diferencia == 0) {
                    texto_diferencia = '&nbsp; No hay diferencia de precio &nbsp;';
                    color = 'white';
                    color_back ="OliveDrab";
                } else {
                    texto_diferencia = '&nbsp; A devolver '+Math.abs(diferencia)+'$ &nbsp;';
                    color = 'white';
                    color_back ="darkorange";
                }
                $('#saliente_diferencia_precio_desc'+line_saliente).html(texto_diferencia);
                $('#saliente_diferencia_precio_desc'+line_saliente).css('color', color);
                $('#saliente_diferencia_precio_desc'+line_saliente).css('background-color', color_back);
                
            }).fail(function(){
                alert('No se encontr√≥ el articulo')
            })   
        }


        $('.cupones').each(function() {
            total_cupon += parseFloat($(this).val());
            contador_cupones += 1;
            if (contador_cupones == total_cupones) {
                $('#total_cupon').val(parseFloat(total_cupon));
            }
            
        });

        
        

    </script>
{% endblock %}